{% extends "base.html" %}

{% block title %}数据仪表板 - YanLing CTF{% endblock %}

{% block extra_css %}
<style>
    .dashboard-container {
        padding: 20px;
        background-color: #f8f9fa;
        min-height: 100vh;
    }
    
    .dashboard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 10px;
        margin-bottom: 30px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .dashboard-header h1 {
        margin: 0;
        font-size: 2.5rem;
        font-weight: 300;
    }
    
    .dashboard-header p {
        margin: 10px 0 0 0;
        opacity: 0.9;
        font-size: 1.1rem;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        text-align: center;
        transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
    }
    
    .stat-icon {
        font-size: 3rem;
        margin-bottom: 15px;
        color: #667eea;
    }
    
    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        color: #333;
        margin-bottom: 5px;
    }
    
    .stat-label {
        color: #666;
        font-size: 1rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 30px;
        margin-bottom: 30px;
    }
    
    .chart-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .chart-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
    }
    
    .chart-title i {
        margin-right: 10px;
        color: #667eea;
    }
    
    .chart-container {
        height: 300px;
        position: relative;
    }
    
    .system-status {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .status-item {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        text-align: center;
    }
    
    .status-icon {
        font-size: 2rem;
        margin-bottom: 10px;
    }
    
    .status-normal { color: #28a745; }
    .status-warning { color: #ffc107; }
    .status-error { color: #dc3545; }
    
    .status-label {
        font-weight: 600;
        margin-bottom: 5px;
    }
    
    .status-value {
        font-size: 1.2rem;
        font-weight: bold;
    }
    
    .activities-section {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .activity-item {
        display: flex;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid #eee;
    }
    
    .activity-item:last-child {
        border-bottom: none;
    }
    
    .activity-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #667eea;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
    }
    
    .activity-content {
        flex: 1;
    }
    
    .activity-text {
        font-weight: 500;
        color: #333;
    }
    
    .activity-time {
        font-size: 0.9rem;
        color: #666;
        margin-top: 2px;
    }
    
    .loading {
        text-align: center;
        padding: 50px;
        color: #666;
    }
    
    .loading i {
        font-size: 2rem;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <h1><i class="fas fa-chart-line"></i> 数据仪表板</h1>
        <p>实时监控平台运行状态和用户活动数据</p>
    </div>
    
    <!-- Platform Statistics -->
    <div class="stats-grid" id="platform-stats">
        <div class="loading">
            <i class="fas fa-spinner"></i>
            <p>加载统计数据中...</p>
        </div>
    </div>
    
    <!-- System Status -->
    <div class="chart-card">
        <div class="chart-title">
            <i class="fas fa-server"></i>
            系统状态
        </div>
        <div class="system-status" id="system-status">
            <div class="loading">
                <i class="fas fa-spinner"></i>
                <p>加载系统状态中...</p>
            </div>
        </div>
    </div>
    
    <!-- Charts Grid -->
    <div class="charts-grid">
        <!-- Challenge Distribution Chart -->
        <div class="chart-card">
            <div class="chart-title">
                <i class="fas fa-chart-pie"></i>
                题目分类分布
            </div>
            <div class="chart-container">
                <canvas id="challengeDistributionChart"></canvas>
            </div>
        </div>
        
        <!-- User Registration Trend -->
        <div class="chart-card">
            <div class="chart-title">
                <i class="fas fa-chart-line"></i>
                用户注册趋势
            </div>
            <div class="chart-container">
                <canvas id="userRegistrationChart"></canvas>
            </div>
        </div>
        
        <!-- Top Users -->
        <div class="chart-card">
            <div class="chart-title">
                <i class="fas fa-trophy"></i>
                用户排行榜
            </div>
            <div class="chart-container" id="top-users-container">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>加载排行榜中...</p>
                </div>
            </div>
        </div>
        
        <!-- Recent Activities -->
        <div class="chart-card">
            <div class="chart-title">
                <i class="fas fa-clock"></i>
                最近活动
            </div>
            <div class="activities-section" id="recent-activities">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>加载活动记录中...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// 全局变量
let challengeChart, userChart;

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    loadPlatformStats();
    loadSystemStatus();
    loadChallengeDistribution();
    loadUserRegistrationTrend();
    loadTopUsers();
    loadRecentActivities();
    
    // 每30秒刷新一次数据
    setInterval(function() {
        loadPlatformStats();
        loadSystemStatus();
        loadRecentActivities();
    }, 30000);
});

// 加载平台统计数据
function loadPlatformStats() {
    fetch('/dashboard/api/platform-statistics')
        .then(response => response.json())
        .then(data => {
            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-users"></i></div>
                    <div class="stat-number">${data.total_users}</div>
                    <div class="stat-label">总用户数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-users-cog"></i></div>
                    <div class="stat-number">${data.total_teams}</div>
                    <div class="stat-label">总团队数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-puzzle-piece"></i></div>
                    <div class="stat-number">${data.total_challenges}</div>
                    <div class="stat-label">总题目数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-paper-plane"></i></div>
                    <div class="stat-number">${data.total_submissions}</div>
                    <div class="stat-label">总提交数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                    <div class="stat-number">${data.success_rate}%</div>
                    <div class="stat-label">成功率</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-user-check"></i></div>
                    <div class="stat-number">${data.active_users}</div>
                    <div class="stat-label">活跃用户</div>
                </div>
            `;
            document.getElementById('platform-stats').innerHTML = statsHtml;
        })
        .catch(error => {
            console.error('Error loading platform stats:', error);
        });
}

// 加载系统状态
function loadSystemStatus() {
    fetch('/dashboard/api/system-status')
        .then(response => response.json())
        .then(data => {
            const statusHtml = `
                <div class="status-item">
                    <div class="status-icon status-${data.database.status}">
                        <i class="fas fa-database"></i>
                    </div>
                    <div class="status-label">数据库</div>
                    <div class="status-value">${data.database.percentage}%</div>
                </div>
                <div class="status-item">
                    <div class="status-icon status-${data.memory.status}">
                        <i class="fas fa-memory"></i>
                    </div>
                    <div class="status-label">内存使用</div>
                    <div class="status-value">${data.memory.percentage}%</div>
                </div>
                <div class="status-item">
                    <div class="status-icon status-${data.disk.status}">
                        <i class="fas fa-hdd"></i>
                    </div>
                    <div class="status-label">磁盘使用</div>
                    <div class="status-value">${data.disk.percentage}%</div>
                </div>
                <div class="status-item">
                    <div class="status-icon status-${data.uptime.status}">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="status-label">运行时间</div>
                    <div class="status-value">${data.uptime.days}天</div>
                </div>
            `;
            document.getElementById('system-status').innerHTML = statusHtml;
        })
        .catch(error => {
            console.error('Error loading system status:', error);
        });
}

// 加载题目分布图表
function loadChallengeDistribution() {
    fetch('/dashboard/api/challenge-distribution')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('challengeDistributionChart').getContext('2d');
            
            if (challengeChart) {
                challengeChart.destroy();
            }
            
            challengeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(item => item.name),
                    datasets: [{
                        data: data.map(item => item.value),
                        backgroundColor: data.map(item => item.color),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error loading challenge distribution:', error);
        });
}

// 加载用户注册趋势图表
function loadUserRegistrationTrend() {
    fetch('/dashboard/api/user-registration-trend')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('userRegistrationChart').getContext('2d');
            
            if (userChart) {
                userChart.destroy();
            }
            
            userChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(item => item.month),
                    datasets: [{
                        label: '新注册用户',
                        data: data.map(item => item.count),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error loading user registration trend:', error);
        });
}

// 加载用户排行榜
function loadTopUsers() {
    fetch('/dashboard/api/top-users')
        .then(response => response.json())
        .then(data => {
            let html = '';
            if (data.length === 0) {
                html = '<div class="text-center text-muted">暂无数据</div>';
            } else {
                data.forEach(user => {
                    const rankIcon = user.rank <= 3 ? 
                        `<i class="fas fa-trophy" style="color: ${user.rank === 1 ? '#ffd700' : user.rank === 2 ? '#c0c0c0' : '#cd7f32'}"></i>` :
                        `<span class="badge badge-secondary">${user.rank}</span>`;
                    
                    html += `
                        <div class="activity-item">
                            <div class="activity-icon">
                                ${rankIcon}
                            </div>
                            <div class="activity-content">
                                <div class="activity-text">${user.username}</div>
                                <div class="activity-time">${user.points} 分 · ${user.solve_count} 题</div>
                            </div>
                        </div>
                    `;
                });
            }
            document.getElementById('top-users-container').innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading top users:', error);
        });
}

// 加载最近活动
function loadRecentActivities() {
    fetch('/dashboard/api/recent-activities')
        .then(response => response.json())
        .then(data => {
            let html = '';
            if (data.length === 0) {
                html = '<div class="text-center text-muted">暂无活动记录</div>';
            } else {
                data.forEach(activity => {
                    html += `
                        <div class="activity-item">
                            <div class="activity-icon">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-text">
                                    <strong>${activity.user}</strong> 解决了 <strong>${activity.challenge}</strong>
                                    <span class="badge badge-success">+${activity.points}</span>
                                </div>
                                <div class="activity-time">${activity.time}</div>
                            </div>
                        </div>
                    `;
                });
            }
            document.getElementById('recent-activities').innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading recent activities:', error);
        });
}
</script>
{% endblock %}